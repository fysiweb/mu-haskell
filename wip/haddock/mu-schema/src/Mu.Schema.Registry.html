<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# language AllowAmbiguousTypes   #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# language DataKinds             #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# language FlexibleContexts      #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# language FlexibleInstances     #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# language MultiParamTypeClasses #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# language PolyKinds             #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# language ScopedTypeVariables   #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# language TypeApplications      #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# language TypeFamilies          #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# language TypeOperators         #-}</span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# language UndecidableInstances  #-}</span><span>
</span><span id="line-12"></span><span class="hs-comment">{-|
Description : Registry of schemas

A registry of schemas saves the different schemas
supported by an application. Since messages and
protocols may evolve, it's useful to keep an updated
view of the different shapes of data we can handle.

Examples of registries are found in
&lt;https://docs.confluent.io/current/schema-registry/index.html Kafka&gt;
and &lt;https://github.com/higherkindness/compendium Compendium&gt;.
-}</span><span>
</span><span id="line-24"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Mu.Schema.Registry</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-25"></span><span>  </span><span class="annot"><span class="hs-comment">-- * Registry of schemas</span></span><span>
</span><span id="line-26"></span><span>  </span><span class="annot"><a href="Mu.Schema.Registry.html#Registry"><span class="hs-identifier">Registry</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Mu.Schema.Registry.html#fromRegistry"><span class="hs-identifier">fromRegistry</span></a></span><span>
</span><span id="line-27"></span><span>  </span><span class="annot"><span class="hs-comment">-- * Terms without an associated schema</span></span><span>
</span><span id="line-28"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Mu.Schema.Interpretation.Schemaless.html#Term"><span class="hs-identifier">SLess.Term</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Mu.Schema.Interpretation.Schemaless.html#Field"><span class="hs-identifier">SLess.Field</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Mu.Schema.Interpretation.Schemaless.html#FieldValue"><span class="hs-identifier">SLess.FieldValue</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-30"></span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Applicative</span></span><span>
</span><span id="line-32"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Kind</span></span><span>
</span><span id="line-33"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Proxy</span></span><span>
</span><span id="line-34"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">GHC.TypeLits</span></span><span>
</span><span id="line-35"></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Mu.Schema.Class.html"><span class="hs-identifier">Mu.Schema.Class</span></a></span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><a href="Mu.Schema.Definition.html"><span class="hs-identifier">Mu.Schema.Definition</span></a></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="Mu.Schema.Interpretation.Schemaless.html"><span class="hs-identifier">Mu.Schema.Interpretation.Schemaless</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">SLess</span></span><span>
</span><span id="line-39"></span><span>
</span><span id="line-40"></span><span class="hs-comment">-- |&#160;A 'Registry' is defined as a map from</span><span>
</span><span id="line-41"></span><span class="hs-comment">--   version numbers to type-level schemas.</span><span>
</span><span id="line-42"></span><span class="hs-comment">--</span><span>
</span><span id="line-43"></span><span class="hs-comment">--   /Implementation note/: you __must__</span><span>
</span><span id="line-44"></span><span class="hs-comment">--   write newer schemas at the head of the</span><span>
</span><span id="line-45"></span><span class="hs-comment">--   'Registry'. Otherwise, older schemas</span><span>
</span><span id="line-46"></span><span class="hs-comment">--   take precedence during conversion.</span><span>
</span><span id="line-47"></span><span class="hs-keyword">type</span><span> </span><span id="Registry"><span class="annot"><a href="Mu.Schema.Registry.html#Registry"><span class="hs-identifier hs-var">Registry</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="Mu.Schema.Definition.html#Mappings"><span class="hs-identifier hs-type">Mappings</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Nat</span></span><span> </span><span class="annot"><a href="Mu.Schema.Definition.html#Schema%27"><span class="hs-identifier hs-type">Schema'</span></a></span><span>
</span><span id="line-48"></span><span>
</span><span id="line-49"></span><span class="hs-comment">-- | Converts a schemaless term into a value</span><span>
</span><span id="line-50"></span><span class="hs-comment">--   by checking all the possible schemas in</span><span>
</span><span id="line-51"></span><span class="hs-comment">--   a 'Registry'.</span><span>
</span><span id="line-52"></span><span class="hs-comment">--</span><span>
</span><span id="line-53"></span><span class="hs-comment">--   /Implementation note/: schemas are checked</span><span>
</span><span id="line-54"></span><span class="hs-comment">--   __in the same order__ in which they appear</span><span>
</span><span id="line-55"></span><span class="hs-comment">--   in the 'Registry' definition.</span><span>
</span><span id="line-56"></span><span class="annot"><a href="Mu.Schema.Registry.html#fromRegistry"><span class="hs-identifier hs-type">fromRegistry</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-keyword">forall</span><span> </span><span id="local-6989586621679216804"><span class="annot"><a href="#local-6989586621679216804"><span class="hs-identifier hs-type">r</span></a></span></span><span> </span><span id="local-6989586621679216803"><span class="annot"><a href="#local-6989586621679216803"><span class="hs-identifier hs-type">t</span></a></span></span><span class="hs-operator">.</span><span> </span><span class="annot"><a href="Mu.Schema.Registry.html#FromRegistry"><span class="hs-identifier hs-type">FromRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679216804"><span class="hs-identifier hs-type">r</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679216803"><span class="hs-identifier hs-type">t</span></a></span><span>
</span><span id="line-57"></span><span>             </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Mu.Schema.Interpretation.Schemaless.html#Term"><span class="hs-identifier hs-type">SLess.Term</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679216803"><span class="hs-identifier hs-type">t</span></a></span><span>
</span><span id="line-58"></span><span id="fromRegistry"><span class="annot"><span class="annottext">fromRegistry :: Term -&gt; Maybe t
</span><a href="Mu.Schema.Registry.html#fromRegistry"><span class="hs-identifier hs-var hs-var">fromRegistry</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Proxy r -&gt; Term -&gt; Maybe t
forall (ms :: Registry) t.
FromRegistry ms t =&gt;
Proxy ms -&gt; Term -&gt; Maybe t
</span><a href="Mu.Schema.Registry.html#fromRegistry%27"><span class="hs-identifier hs-var">fromRegistry'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proxy r
forall k (t :: k). Proxy t
</span><span class="hs-identifier hs-var">Proxy</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679216804"><span class="hs-identifier hs-type">r</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span class="hs-keyword">class</span><span> </span><span id="FromRegistry"><span class="annot"><a href="Mu.Schema.Registry.html#FromRegistry"><span class="hs-identifier hs-var">FromRegistry</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679216836"><span class="annot"><a href="#local-6989586621679216836"><span class="hs-identifier hs-type">ms</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="Mu.Schema.Registry.html#Registry"><span class="hs-identifier hs-type">Registry</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679216835"><span class="annot"><a href="#local-6989586621679216835"><span class="hs-identifier hs-type">t</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Type</span></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-61"></span><span>  </span><span id="fromRegistry%27"><span class="annot"><a href="Mu.Schema.Registry.html#fromRegistry%27"><span class="hs-identifier hs-type">fromRegistry'</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Proxy</span></span><span> </span><span class="annot"><a href="#local-6989586621679216836"><span class="hs-identifier hs-type">ms</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="Mu.Schema.Interpretation.Schemaless.html#Term"><span class="hs-identifier hs-type">SLess.Term</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Maybe</span></span><span> </span><span class="annot"><a href="#local-6989586621679216835"><span class="hs-identifier hs-type">t</span></a></span><span>
</span><span id="line-62"></span><span>
</span><span id="line-63"></span><span id="local-6989586621679216800"><span class="hs-keyword">instance</span><span> </span><span class="annot"><a href="Mu.Schema.Registry.html#FromRegistry"><span class="hs-identifier hs-type">FromRegistry</span></a></span><span> </span><span class="hs-special">'</span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="annot"><a href="#local-6989586621679216800"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-64"></span><span>  </span><span id="local-6989586621679216797"><span class="annot"><span class="annottext">fromRegistry' :: Proxy '[] -&gt; Term -&gt; Maybe t
</span><a href="#local-6989586621679216797"><span class="hs-identifier hs-var hs-var hs-var hs-var">fromRegistry'</span></a></span></span><span> </span><span class="annot"><span class="annottext">Proxy '[]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Term
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe t
forall a. Maybe a
</span><span class="hs-identifier hs-var">Nothing</span></span></span><span>
</span><span id="line-65"></span><span id="local-6989586621679216791"><span id="local-6989586621679216792"><span id="local-6989586621679216793"><span id="local-6989586621679216794"><span id="local-6989586621679216795"><span id="local-6989586621679216796"><span class="hs-keyword">instance</span><span> </span><span class="hs-special">(</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Traversable</span></span><span> </span><span class="annot"><a href="#local-6989586621679216796"><span class="hs-identifier hs-type">w</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Mu.Schema.Class.html#FromSchema"><span class="hs-identifier hs-type">FromSchema</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679216795"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679216794"><span class="hs-identifier hs-type">sty</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679216793"><span class="hs-identifier hs-type">t</span></a></span><span>
</span><span id="line-66"></span><span>         </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Mu.Schema.Interpretation.Schemaless.html#CheckSchema"><span class="hs-identifier hs-type">SLess.CheckSchema</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679216795"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679216795"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><a href="Mu.Schema.Definition.html#%3A%2F%3A"><span class="hs-operator hs-type">:/:</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679216794"><span class="hs-identifier hs-type">sty</span></a></span><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Mu.Schema.Registry.html#FromRegistry"><span class="hs-identifier hs-type">FromRegistry</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679216792"><span class="hs-identifier hs-type">ms</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679216793"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-special">)</span><span>
</span><span id="line-67"></span><span>         </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Mu.Schema.Registry.html#FromRegistry"><span class="hs-identifier hs-type">FromRegistry</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="#local-6989586621679216791"><span class="hs-identifier hs-type">n</span></a></span><span> </span><span class="hs-special">'</span><span class="hs-operator">:-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679216795"><span class="hs-identifier hs-type">s</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">'</span><span class="hs-glyph">:</span><span> </span><span class="annot"><a href="#local-6989586621679216792"><span class="hs-identifier hs-type">ms</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="#local-6989586621679216793"><span class="hs-identifier hs-type">t</span></a></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-68"></span><span>  </span><span id="local-6989586621679216789"><span class="annot"><span class="annottext">fromRegistry' :: Proxy ((n ':-&gt; s) : ms) -&gt; Term -&gt; Maybe t
</span><a href="#local-6989586621679216789"><span class="hs-identifier hs-var hs-var hs-var hs-var">fromRegistry'</span></a></span></span><span> </span><span class="annot"><span class="annottext">Proxy ((n ':-&gt; s) : ms)
</span><span class="hs-identifier">_</span></span><span> </span><span id="local-6989586621679216788"><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621679216788"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Term -&gt; Maybe t
forall t1 f (sch :: Schema t1 f) t2 (sty :: t1).
(FromSchema sch sty t2, CheckSchema sch (sch :/: sty)) =&gt;
Term -&gt; Maybe t2
</span><a href="Mu.Schema.Interpretation.Schemaless.html#fromSchemalessTerm"><span class="hs-identifier hs-var">SLess.fromSchemalessTerm</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679216795"><span class="hs-identifier hs-type">s</span></a></span><span> </span><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621679216788"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe t -&gt; Maybe t -&gt; Maybe t
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">Proxy ms -&gt; Term -&gt; Maybe t
forall (ms :: Registry) t.
FromRegistry ms t =&gt;
Proxy ms -&gt; Term -&gt; Maybe t
</span><a href="Mu.Schema.Registry.html#fromRegistry%27"><span class="hs-identifier hs-var">fromRegistry'</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Proxy ms
forall k (t :: k). Proxy t
</span><span class="hs-identifier hs-var">Proxy</span></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="#local-6989586621679216792"><span class="hs-identifier hs-type">ms</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Term
</span><a href="#local-6989586621679216788"><span class="hs-identifier hs-var">t</span></a></span></span></span></span></span></span></span><span>
</span><span id="line-69"></span></pre></body></html>