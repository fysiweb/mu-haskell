<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# language FlexibleInstances     #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# language MultiParamTypeClasses #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# language OverloadedStrings     #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# language PolyKinds             #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# language UndecidableInstances  #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# language ViewPatterns          #-}</span><span>
</span><span id="line-7"></span><span class="hs-comment">{-|
Description : Distributed tracing for Mu

This module injects distributed tracing
for Mu servers. Currently it only supports
Zipkin as backend.

In order to use this module, you need to
follow these steps:

1. Establish a connection with 'newZipkin'.
2. Wrap the server using 'zipkin', giving
   information for the root.
3. Run the server using the transformer version
   of your protocol, like |grpcAppTrans|.
-}</span><span>
</span><span id="line-23"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Mu.Instrumentation.Tracing</span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-24"></span><span>  </span><span class="annot"><span class="hs-comment">-- * Distributed tracing</span></span><span>
</span><span id="line-25"></span><span>  </span><span class="annot"><a href="Mu.Instrumentation.Tracing.html#MuTracing"><span class="hs-identifier">MuTracing</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Mu.Instrumentation.Tracing.html#zipkin"><span class="hs-identifier">zipkin</span></a></span><span>
</span><span id="line-27"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Mu.Instrumentation.Tracing.html#runZipkin"><span class="hs-identifier">runZipkin</span></a></span><span>
</span><span id="line-28"></span><span>  </span><span class="annot"><span class="hs-comment">-- ** Establish connection</span></span><span>
</span><span id="line-29"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Mu.Instrumentation.Tracing.html#newZipkin"><span class="hs-identifier">newZipkin</span></a></span><span>
</span><span id="line-30"></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="Mu.Instrumentation.Tracing.html#defaultZipkinSettings"><span class="hs-identifier">defaultZipkinSettings</span></a></span><span>
</span><span id="line-31"></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier">Settings</span></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span>  </span><span class="annot"><span class="hs-comment">-- * Useful re-exports</span></span><span>
</span><span id="line-33"></span><span class="hs-special">,</span><span> </span><span class="hs-keyword">module</span><span> </span><span class="annot"><span class="hs-identifier">Monitor.Tracing</span></span><span>
</span><span id="line-34"></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-35"></span><span>
</span><span id="line-36"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Applicative</span></span><span>       </span><span class="hs-special">(</span><span class="annot"><span class="hs-operator">(&lt;|&gt;)</span></span><span class="hs-special">)</span><span>
</span><span id="line-37"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.IO.Class</span></span><span>
</span><span id="line-38"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Trace</span></span><span>
</span><span id="line-39"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Control.Monad.Trace.Class</span></span><span>
</span><span id="line-40"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span>           </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-41"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Data.Text</span></span><span>
</span><span id="line-42"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Monitor.Tracing</span></span><span>
</span><span id="line-43"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Monitor.Tracing.Zipkin</span></span><span>
</span><span id="line-44"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Mu.Rpc</span></span><span>
</span><span id="line-45"></span><span class="hs-keyword">import</span><span>           </span><span class="annot"><span class="hs-identifier">Mu.Server</span></span><span>
</span><span id="line-46"></span><span>
</span><span id="line-47"></span><span class="hs-keyword">data</span><span> </span><span id="MuTracing"><span class="annot"><a href="Mu.Instrumentation.Tracing.html#MuTracing"><span class="hs-identifier hs-var">MuTracing</span></a></span></span><span>
</span><span id="line-48"></span><span>  </span><span class="hs-glyph">=</span><span> </span><span id="MuTracing"><span class="annot"><a href="Mu.Instrumentation.Tracing.html#MuTracing"><span class="hs-identifier hs-var">MuTracing</span></a></span></span><span> </span><span class="hs-special">{</span><span>
</span><span id="line-49"></span><span>      </span><span id="samplingPolicy"><span class="annot"><span class="annottext">MuTracing -&gt; SamplingPolicy
</span><a href="Mu.Instrumentation.Tracing.html#samplingPolicy"><span class="hs-identifier hs-var hs-var">samplingPolicy</span></a></span></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">SamplingPolicy</span></span><span>
</span><span id="line-50"></span><span>    </span><span class="hs-special">,</span><span> </span><span id="rootName"><span class="annot"><span class="annottext">MuTracing -&gt; Text
</span><a href="Mu.Instrumentation.Tracing.html#rootName"><span class="hs-identifier hs-var hs-var">rootName</span></a></span></span><span>       </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Text</span></span><span>
</span><span id="line-51"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-52"></span><span>
</span><span id="line-53"></span><span class="hs-comment">-- | Runs with a given 'Zipkin' connection.</span><span>
</span><span id="line-54"></span><span class="hs-comment">--   You can create one with 'newZipkin'.</span><span>
</span><span id="line-55"></span><span id="local-6989586621679080018"><span id="local-6989586621679080019"><span class="annot"><a href="Mu.Instrumentation.Tracing.html#runZipkin"><span class="hs-identifier hs-type">runZipkin</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Zipkin</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">TraceT</span></span><span> </span><span class="annot"><a href="#local-6989586621679080019"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080018"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679080019"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080018"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-56"></span><span id="runZipkin"><span class="annot"><span class="annottext">runZipkin :: Zipkin -&gt; TraceT m a -&gt; m a
</span><a href="Mu.Instrumentation.Tracing.html#runZipkin"><span class="hs-identifier hs-var hs-var">runZipkin</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(TraceT m a -&gt; Zipkin -&gt; m a) -&gt; Zipkin -&gt; TraceT m a -&gt; m a
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">TraceT m a -&gt; Zipkin -&gt; m a
forall (m :: * -&gt; *) a. TraceT m a -&gt; Zipkin -&gt; m a
</span><span class="hs-identifier hs-var">run</span></span><span>
</span><span id="line-57"></span><span>
</span><span id="line-58"></span><span class="hs-comment">-- |&#160;Create a new connection to 'Zipkin'.</span><span>
</span><span id="line-59"></span><span class="annot"><a href="Mu.Instrumentation.Tracing.html#newZipkin"><span class="hs-identifier hs-type">newZipkin</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Settings</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">IO</span></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Zipkin</span></span><span>
</span><span id="line-60"></span><span id="newZipkin"><span class="annot"><span class="annottext">newZipkin :: Settings -&gt; IO Zipkin
</span><a href="Mu.Instrumentation.Tracing.html#newZipkin"><span class="hs-identifier hs-var hs-var">newZipkin</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Settings -&gt; IO Zipkin
forall (m :: * -&gt; *). MonadIO m =&gt; Settings -&gt; m Zipkin
</span><span class="hs-identifier hs-var">new</span></span><span>
</span><span id="line-61"></span><span>
</span><span id="line-62"></span><span class="annot"><a href="Mu.Instrumentation.Tracing.html#defaultZipkinSettings"><span class="hs-identifier hs-type">defaultZipkinSettings</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">Settings</span></span><span>
</span><span id="line-63"></span><span id="defaultZipkinSettings"><span class="annot"><span class="annottext">defaultZipkinSettings :: Settings
</span><a href="Mu.Instrumentation.Tracing.html#defaultZipkinSettings"><span class="hs-identifier hs-var hs-var">defaultZipkinSettings</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Settings
</span><span class="hs-identifier hs-var">defaultSettings</span></span><span>
</span><span id="line-64"></span><span>
</span><span id="line-65"></span><span class="hs-comment">-- | Wraps a server to do distributed tracing</span><span>
</span><span id="line-66"></span><span class="hs-comment">--   using 'Zipkin' as backend.</span><span>
</span><span id="line-67"></span><span id="local-6989586621679080009"><span id="local-6989586621679080010"><span id="local-6989586621679080011"><span id="local-6989586621679080012"><span id="local-6989586621679080013"><span class="annot"><a href="Mu.Instrumentation.Tracing.html#zipkin"><span class="hs-identifier hs-type">zipkin</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679080013"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadTrace</span></span><span> </span><span class="annot"><a href="#local-6989586621679080013"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span>       </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Mu.Instrumentation.Tracing.html#MuTracing"><span class="hs-identifier hs-type">MuTracing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ServerT</span></span><span> </span><span class="annot"><a href="#local-6989586621679080012"><span class="hs-identifier hs-type">chn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080011"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080010"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080013"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080009"><span class="hs-identifier hs-type">topHs</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ServerT</span></span><span> </span><span class="annot"><a href="#local-6989586621679080012"><span class="hs-identifier hs-type">chn</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080011"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080010"><span class="hs-identifier hs-type">p</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080013"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080009"><span class="hs-identifier hs-type">topHs</span></a></span></span></span></span></span></span><span>
</span><span id="line-69"></span><span id="zipkin"><span class="annot"><span class="annottext">zipkin :: MuTracing -&gt; ServerT chn i p m topHs -&gt; ServerT chn i p m topHs
</span><a href="Mu.Instrumentation.Tracing.html#zipkin"><span class="hs-identifier hs-var hs-var">zipkin</span></a></span></span><span> </span><span id="local-6989586621679080008"><span class="annot"><span class="annottext">MuTracing
</span><a href="#local-6989586621679080008"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(forall a. RpcInfo i -&gt; m a -&gt; m a)
-&gt; ServerT chn i p m topHs -&gt; ServerT chn i p m topHs
forall snm mnm anm (chn :: ServiceChain snm) info
       (p :: Package snm mnm anm (TypeRef snm)) (m :: * -&gt; *)
       (topHs :: [[*]]).
(forall a. RpcInfo info -&gt; m a -&gt; m a)
-&gt; ServerT chn info p m topHs -&gt; ServerT chn info p m topHs
</span><span class="hs-identifier hs-var">wrapServer</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MuTracing -&gt; RpcInfo i -&gt; m a -&gt; m a
forall (m :: * -&gt; *) i a.
(MonadIO m, MonadTrace m) =&gt;
MuTracing -&gt; RpcInfo i -&gt; m a -&gt; m a
</span><a href="Mu.Instrumentation.Tracing.html#zipkinTracing"><span class="hs-identifier hs-var">zipkinTracing</span></a></span><span> </span><span class="annot"><span class="annottext">MuTracing
</span><a href="#local-6989586621679080008"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-70"></span><span>
</span><span id="line-71"></span><span id="local-6989586621679080053"><span id="local-6989586621679080054"><span id="local-6989586621679080056"><span class="annot"><a href="Mu.Instrumentation.Tracing.html#zipkinTracing"><span class="hs-identifier hs-type">zipkinTracing</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">MonadIO</span></span><span> </span><span class="annot"><a href="#local-6989586621679080056"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadTrace</span></span><span> </span><span class="annot"><a href="#local-6989586621679080056"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-72"></span><span>              </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="Mu.Instrumentation.Tracing.html#MuTracing"><span class="hs-identifier hs-type">MuTracing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="hs-identifier hs-type">RpcInfo</span></span><span> </span><span class="annot"><a href="#local-6989586621679080054"><span class="hs-identifier hs-type">i</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679080056"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080053"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679080056"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679080053"><span class="hs-identifier hs-type">a</span></a></span></span></span></span><span>
</span><span id="line-73"></span><span id="zipkinTracing"><span class="annot"><span class="annottext">zipkinTracing :: MuTracing -&gt; RpcInfo i -&gt; m a -&gt; m a
</span><a href="Mu.Instrumentation.Tracing.html#zipkinTracing"><span class="hs-identifier hs-var hs-var">zipkinTracing</span></a></span></span><span> </span><span id="local-6989586621679080005"><span class="annot"><span class="annottext">MuTracing
</span><a href="#local-6989586621679080005"><span class="hs-identifier hs-var">zpk</span></a></span></span><span> </span><span class="annot"><span class="annottext">RpcInfo i
</span><span class="hs-identifier hs-var">NoRpcInfo</span></span><span> </span><span id="local-6989586621679080003"><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679080003"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-74"></span><span>  </span><span class="annot"><span class="annottext">SamplingPolicy -&gt; Text -&gt; m a -&gt; m a
forall (m :: * -&gt; *) a.
MonadTrace m =&gt;
SamplingPolicy -&gt; Text -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">rootSpan</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MuTracing -&gt; SamplingPolicy
</span><a href="Mu.Instrumentation.Tracing.html#samplingPolicy"><span class="hs-identifier hs-var hs-var">samplingPolicy</span></a></span><span> </span><span class="annot"><span class="annottext">MuTracing
</span><a href="#local-6989586621679080005"><span class="hs-identifier hs-var">zpk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MuTracing -&gt; Text
</span><a href="Mu.Instrumentation.Tracing.html#rootName"><span class="hs-identifier hs-var hs-var">rootName</span></a></span><span> </span><span class="annot"><span class="annottext">MuTracing
</span><a href="#local-6989586621679080005"><span class="hs-identifier hs-var">zpk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679080003"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-75"></span><span class="annot"><a href="Mu.Instrumentation.Tracing.html#zipkinTracing"><span class="hs-identifier hs-var">zipkinTracing</span></a></span><span> </span><span id="local-6989586621679080001"><span class="annot"><span class="annottext">MuTracing
</span><a href="#local-6989586621679080001"><span class="hs-identifier hs-var">zpk</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-identifier hs-type">RpcInfo</span></span><span> </span><span class="annot"><span class="annottext">Package Text Text Text TyInfo
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Service Text Text Text TyInfo
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Maybe (Method Text Text Text TyInfo)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RequestHeaders -&gt; Map HeaderName ByteString
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span id="local-6989586621679079998"><span class="annot"><span class="annottext">Map HeaderName ByteString
</span><a href="#local-6989586621679079998"><span class="hs-identifier hs-var">hdrs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">i
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679079997"><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679079997"><span class="hs-identifier hs-var">h</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-76"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe B3
</span><a href="#local-6989586621679079996"><span class="hs-identifier hs-var">getB3</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-77"></span><span>    </span><span class="annot"><span class="annottext">Maybe B3
</span><span class="hs-identifier hs-var">Nothing</span></span><span>  </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">SamplingPolicy -&gt; Text -&gt; m a -&gt; m a
forall (m :: * -&gt; *) a.
MonadTrace m =&gt;
SamplingPolicy -&gt; Text -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">rootSpan</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MuTracing -&gt; SamplingPolicy
</span><a href="Mu.Instrumentation.Tracing.html#samplingPolicy"><span class="hs-identifier hs-var hs-var">samplingPolicy</span></a></span><span> </span><span class="annot"><span class="annottext">MuTracing
</span><a href="#local-6989586621679080001"><span class="hs-identifier hs-var">zpk</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MuTracing -&gt; Text
</span><a href="Mu.Instrumentation.Tracing.html#rootName"><span class="hs-identifier hs-var hs-var">rootName</span></a></span><span> </span><span class="annot"><span class="annottext">MuTracing
</span><a href="#local-6989586621679080001"><span class="hs-identifier hs-var">zpk</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679079997"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-78"></span><span>    </span><span class="annot"><span class="hs-identifier hs-type">Just</span></span><span> </span><span id="local-6989586621679079995"><span class="annot"><span class="annottext">B3
</span><a href="#local-6989586621679079995"><span class="hs-identifier hs-var">spn</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">B3 -&gt; m a -&gt; m a
forall (m :: * -&gt; *) a. MonadTrace m =&gt; B3 -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">serverSpan</span></span><span> </span><span class="annot"><span class="annottext">B3
</span><a href="#local-6989586621679079995"><span class="hs-identifier hs-var">spn</span></a></span><span> </span><span class="annot"><span class="annottext">m a
</span><a href="#local-6989586621679079997"><span class="hs-identifier hs-var">h</span></a></span><span>
</span><span id="line-79"></span><span>  </span><span class="hs-keyword">where</span><span> </span><span id="local-6989586621679079996"><span class="annot"><span class="annottext">getB3 :: Maybe B3
</span><a href="#local-6989586621679079996"><span class="hs-identifier hs-var hs-var">getB3</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>   </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ByteString -&gt; Maybe B3
</span><span class="hs-identifier hs-var">b3FromHeaderValue</span></span><span> </span><span class="annot"><span class="annottext">(ByteString -&gt; Maybe B3) -&gt; Maybe ByteString -&gt; Maybe B3
forall (m :: * -&gt; *) a b. Monad m =&gt; (a -&gt; m b) -&gt; m a -&gt; m b
</span><span class="hs-operator hs-var">=&lt;&lt;</span></span><span> </span><span class="annot"><span class="annottext">HeaderName -&gt; Map HeaderName ByteString -&gt; Maybe ByteString
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><span class="hs-identifier hs-var">M.lookup</span></span><span> </span><span class="annot"><span class="annottext">HeaderName
</span><span class="hs-string">&quot;b3&quot;</span></span><span> </span><span class="annot"><span class="annottext">Map HeaderName ByteString
</span><a href="#local-6989586621679079998"><span class="hs-identifier hs-var">hdrs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-80"></span><span>              </span><span class="annot"><span class="annottext">Maybe B3 -&gt; Maybe B3 -&gt; Maybe B3
forall (f :: * -&gt; *) a. Alternative f =&gt; f a -&gt; f a -&gt; f a
</span><span class="hs-operator hs-var">&lt;|&gt;</span></span><span> </span><span class="annot"><span class="annottext">Map HeaderName ByteString -&gt; Maybe B3
</span><span class="hs-identifier hs-var">b3FromHeaders</span></span><span> </span><span class="annot"><span class="annottext">Map HeaderName ByteString
</span><a href="#local-6989586621679079998"><span class="hs-identifier hs-var">hdrs</span></a></span><span>
</span><span id="line-81"></span></pre></body></html>